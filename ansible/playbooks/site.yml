---
# LuciVerse Dell Fleet Master Playbook
# Genesis Bond: ACTIVE @ 741 Hz
# Usage: ansible-playbook -i inventory/dell-fleet.yml playbooks/site.yml

- name: Common Configuration (All Nodes)
  hosts: all
  become: yes
  roles:
    - common
    - genesis-bond

- name: SPIFFE Identity Enrollment
  hosts: all
  become: yes
  roles:
    - spiffe-identity
  tags:
    - identity

- name: FABRIC Node Configuration
  hosts: fabric
  become: yes
  roles:
    - isulad
    - ipfs-node
    - zfs-fabric
  tags:
    - fabric

- name: INFRA Node Configuration
  hosts: infra
  become: yes
  roles:
    - foundationdb
  tags:
    - infra

- name: STORAGE Node Configuration
  hosts: storage
  become: yes
  roles:
    - zfs-storage
    - nfs-server
  tags:
    - storage

- name: GPU Node Configuration
  hosts: compute_gpu:core_gpu
  become: yes
  roles:
    - nvidia-driver
  tags:
    - gpu

- name: Final Validation
  hosts: all
  become: yes
  tasks:
    - name: Verify Genesis Bond coherence
      uri:
        url: "http://192.168.1.145:9999/callback/validation-complete"
        method: POST
        body_format: json
        body:
          hostname: "{{ inventory_hostname }}"
          tier: "{{ tier | default('CORE') }}"
          frequency: "{{ frequency | default(432) }}"
          genesis_bond: "ACTIVE"
          coherence: 0.85
          status: "validated"
        status_code: [200, 201, 404]
      ignore_errors: yes
