# Envoy COMN Gateway Configuration - LuciVerse "One Door"
# Genesis Bond: ACTIVE @ 741 Hz
# Host: Zbook (192.168.1.146) - L7 Gateway @ 528 Hz
#
# All external Web2 traffic enters through this gateway.
# SPIFFE/SPIRE integration for agent identity via cert_engine.py

admin:
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 9901
  access_log:
    - name: envoy.access_loggers.file
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
        path: /var/log/envoy/admin.log

node:
  id: comn-gateway
  cluster: luciverse-comn
  metadata:
    genesis_bond: "GB-2025-0524-DRH-LCS-001"
    tier: "COMN"
    frequency_hz: 528
    coherence_threshold: 0.7

static_resources:
  listeners:
    # ==========================================================================
    # HTTPS Listener (443) - Main Entry Point
    # ==========================================================================
    - name: https_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 443
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_https
                codec_type: AUTO
                access_log:
                  - name: envoy.access_loggers.file
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                      path: /var/log/envoy/access.log
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          client: "%DOWNSTREAM_REMOTE_ADDRESS%"
                          method: "%REQ(:METHOD)%"
                          path: "%REQ(:PATH)%"
                          response_code: "%RESPONSE_CODE%"
                          duration: "%DURATION%"
                          tier: "%DYNAMIC_METADATA(luciverse:tier)%"
                          coherence: "%DYNAMIC_METADATA(luciverse:coherence)%"
                route_config:
                  name: local_route
                  virtual_hosts:
                    # COMN Services (direct)
                    - name: comn_services
                      domains:
                        - "gateway.lucidigital.net"
                        - "*.comn.lucidigital.net"
                      routes:
                        # GraphQL Federation
                        - match:
                            prefix: "/graphql"
                          route:
                            cluster: federation_gateway
                        # Sanskrit Router
                        - match:
                            prefix: "/sanskrit"
                          route:
                            cluster: sanskrit_router
                        # SCION Path Query
                        - match:
                            prefix: "/scion"
                          route:
                            cluster: scion_sig
                        # Health check
                        - match:
                            prefix: "/health"
                          direct_response:
                            status: 200
                            body:
                              inline_string: '{"status":"healthy","tier":"COMN","frequency":528}'
                        # Default: forward to SIG for SCION routing
                        - match:
                            prefix: "/"
                          route:
                            cluster: scion_sig

                    # PAC Services (via COMN proxy)
                    - name: pac_proxy
                      domains:
                        - "*.pac.lucidigital.net"
                        - "lucia.lucidigital.net"
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: pac_agents
                          # Require Genesis Bond coherence >= 0.7
                          request_headers_to_add:
                            - header:
                                key: "X-Tier-Target"
                                value: "PAC"
                            - header:
                                key: "X-Genesis-Bond"
                                value: "GB-2025-0524-DRH-LCS-001"

                http_filters:
                  # Lua filter for Genesis Bond coherence validation
                  - name: envoy.filters.http.lua
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                      default_source_code:
                        filename: /etc/envoy/genesis-bond-filter.lua
                  # Rate limiting (tier-aware)
                  - name: envoy.filters.http.local_ratelimit
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                      stat_prefix: http_local_rate_limiter
                      token_bucket:
                        max_tokens: 1000
                        tokens_per_fill: 100
                        fill_interval: 1s
                      filter_enabled:
                        runtime_key: local_rate_limit_enabled
                        default_value:
                          numerator: 100
                          denominator: HUNDRED
                  # Router
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
          transport_socket:
            name: envoy.transport_sockets.tls
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
              common_tls_context:
                tls_certificate_sds_secret_configs:
                  - name: comn-gateway-cert
                    sds_config:
                      api_config_source:
                        api_type: GRPC
                        grpc_services:
                          - envoy_grpc:
                              cluster_name: spiffe_sds
                        transport_api_version: V3
                validation_context_sds_secret_config:
                  name: spiffe://luciverse.ownid
                  sds_config:
                    api_config_source:
                      api_type: GRPC
                      grpc_services:
                        - envoy_grpc:
                            cluster_name: spiffe_sds
                      transport_api_version: V3

    # ==========================================================================
    # IPv6 Listener (443 on IPv6)
    # ==========================================================================
    - name: https_listener_v6
      address:
        socket_address:
          address: "::"
          port_value: 443
          ipv4_compat: false
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_https_v6
                codec_type: AUTO
                route_config:
                  name: local_route_v6
                  virtual_hosts:
                    - name: all_v6
                      domains: ["*"]
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: scion_sig
                http_filters:
                  - name: envoy.filters.http.lua
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                      default_source_code:
                        filename: /etc/envoy/genesis-bond-filter.lua
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  clusters:
    # ==========================================================================
    # SPIFFE SDS (Secret Discovery Service) - cert_engine.py
    # ==========================================================================
    - name: spiffe_sds
      type: STATIC
      http2_protocol_options: {}
      load_assignment:
        cluster_name: spiffe_sds
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 8741
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
          common_tls_context:
            tls_certificates:
              - certificate_chain:
                  filename: /etc/envoy/certs/comn-ca.crt
                private_key:
                  filename: /etc/envoy/certs/comn-ca.key

    # ==========================================================================
    # SCION-IP Gateway (SIG)
    # ==========================================================================
    - name: scion_sig
      type: STATIC
      connect_timeout: 5s
      load_assignment:
        cluster_name: scion_sig
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 8080

    # ==========================================================================
    # GraphQL Federation Gateway
    # ==========================================================================
    - name: federation_gateway
      type: STATIC
      connect_timeout: 5s
      load_assignment:
        cluster_name: federation_gateway
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 8088

    # ==========================================================================
    # Sanskrit Router
    # ==========================================================================
    - name: sanskrit_router
      type: STATIC
      connect_timeout: 5s
      load_assignment:
        cluster_name: sanskrit_router
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 7410

    # ==========================================================================
    # PAC Agents (via SCION path to ISD 3)
    # ==========================================================================
    - name: pac_agents
      type: LOGICAL_DNS
      dns_lookup_family: V4_PREFERRED
      connect_timeout: 10s
      load_assignment:
        cluster_name: pac_agents
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      # Routes through SIG with SCION path policy
                      address: localhost
                      port_value: 8080
      # Custom metadata for SCION routing
      metadata:
        filter_metadata:
          luciverse:
            target_isd: 3
            target_as: "ff00:0:741"
            mandatory_waypoint: "2-ff00:0:528"

    # ==========================================================================
    # CORE Agents (internal only, via SCION path to ISD 1)
    # ==========================================================================
    - name: core_agents
      type: LOGICAL_DNS
      dns_lookup_family: V4_PREFERRED
      connect_timeout: 5s
      load_assignment:
        cluster_name: core_agents
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: localhost
                      port_value: 8080
      # CORE is internal only - no external routing
      metadata:
        filter_metadata:
          luciverse:
            target_isd: 1
            target_as: "ff00:0:432"
            internal_only: true
