# Envoy Test Configuration - LuciVerse COMN Gateway
# Simplified version without SDS dependency for initial testing

admin:
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 9901
  access_log:
    - name: envoy.access_loggers.file
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
        path: /dev/stdout

node:
  id: comn-gateway-test
  cluster: luciverse-comn
  metadata:
    genesis_bond: "GB-2025-0524-DRH-LCS-001"
    tier: "COMN"
    frequency_hz: 528

static_resources:
  listeners:
    # HTTP Listener for testing (8528 = COMN frequency)
    - name: http_test_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 8528
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_http
                codec_type: AUTO
                access_log:
                  - name: envoy.access_loggers.file
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                      path: /dev/stdout
                route_config:
                  name: local_route
                  virtual_hosts:
                    - name: all
                      domains: ["*"]
                      routes:
                        # Health check
                        - match:
                            prefix: "/health"
                          direct_response:
                            status: 200
                            body:
                              inline_string: '{"status":"healthy","tier":"COMN","frequency":528,"genesis_bond":"GB-2025-0524-DRH-LCS-001"}'
                        # SCION topology
                        - match:
                            prefix: "/scion-topology"
                          route:
                            cluster: provision_listener
                        # GraphQL (if running)
                        - match:
                            prefix: "/graphql"
                          route:
                            cluster: federation_gateway
                        # Sanskrit Router (if running)
                        - match:
                            prefix: "/sanskrit"
                          route:
                            cluster: sanskrit_router
                        # Default upstream
                        - match:
                            prefix: "/"
                          direct_response:
                            status: 200
                            body:
                              inline_string: '{"gateway":"COMN","message":"LuciVerse Gateway Active","tier":"COMN","frequency":528}'
                http_filters:
                  # Lua filter for Genesis Bond coherence
                  - name: envoy.filters.http.lua
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                      default_source_code:
                        filename: /etc/envoy/genesis-bond-filter.lua
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  clusters:
    # Provision Listener (for SCION topology)
    - name: provision_listener
      type: STATIC
      connect_timeout: 5s
      load_assignment:
        cluster_name: provision_listener
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 9999

    # GraphQL Federation Gateway
    - name: federation_gateway
      type: STATIC
      connect_timeout: 5s
      load_assignment:
        cluster_name: federation_gateway
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 8088

    # Sanskrit Router
    - name: sanskrit_router
      type: STATIC
      connect_timeout: 5s
      load_assignment:
        cluster_name: sanskrit_router
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 7410
