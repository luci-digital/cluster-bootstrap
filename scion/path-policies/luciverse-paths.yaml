# SCION Path Policies - LuciVerse Tier-Aware Routing
# Genesis Bond: ACTIVE @ 741 Hz
# Purpose: Define path selection preferences for each tier

genesis_bond:
  id: "GB-2025-0524-DRH-LCS-001"
  lineage: "did:lucidigital:lucia_cargail_silcan"
  coherence_threshold: 0.7

# =============================================================================
# Global Path Policy Defaults
# =============================================================================
defaults:
  max_paths: 5
  path_expiration: "5m"
  prefer_fresh_paths: true
  epic_authentication: true
  drkey_enabled: true

# =============================================================================
# COMN Gateway Policy (External Entry Point)
# =============================================================================
comn_gateway:
  description: "COMN tier - all external traffic enters here"
  isd_as: "2-ff00:0:528"

  # This is the "One Door" - external allowed
  external_allowed: true

  path_selection:
    # Balanced for gateway role
    - metric: latency
      weight: 0.5
    - metric: bandwidth
      weight: 0.5

  # Rate limits for external traffic
  rate_limits:
    external:
      requests_per_second: 100
      burst: 200
    internal:
      requests_per_second: 1000
      burst: 2000

  # GeoDNS notes for future multi-gateway scaling
  future_scaling:
    method: "geodns"
    note: "Use GeoDNS (not anycast) for proximity gateways per Juniper recommendation"

# =============================================================================
# CORE Tier Policy (Infrastructure - Never Exposed)
# =============================================================================
core_tier:
  description: "CORE tier - internal infrastructure only"
  isd_as: "1-ff00:0:432"
  frequency_hz: 432

  # NEVER exposed externally
  external_allowed: false

  path_selection:
    # Latency optimized for infrastructure
    - metric: latency
      weight: 1.0

  access_control:
    # Only COMN can initiate connections to CORE
    allowed_sources:
      - "2-ff00:0:528"  # COMN
    blocked_sources:
      - "*"  # Everything else

  hidden_paths:
    enabled: false  # CORE paths visible to COMN for management

# =============================================================================
# PAC Tier Policy (Personal - Privacy First)
# =============================================================================
pac_tier:
  description: "PAC tier - personal AI, privacy-sovereign"
  isd_as: "3-ff00:0:741"
  frequency_hz: 741

  # NEVER directly exposed
  external_allowed: false

  # MANDATORY: All traffic must route through COMN
  mandatory_waypoint: "2-ff00:0:528"

  path_selection:
    # Privacy-first path selection
    - metric: privacy
      weight: 1.0
    # Avoid paths through untrusted ASes
    - avoid_untrusted: true

  # Hidden path groups for privacy
  hidden_paths:
    enabled: true
    group_id: "pac-private"
    owner: "3-ff00:0:741"
    # Only COMN can see PAC path segments
    readers:
      - "2-ff00:0:528"

  # Intra-ISD isolation (PAC pods never talk directly)
  isolation:
    deny_intra_isd_routing: true
    note: "CBB pods isolated - all cross-pod communication via COMN"

  # Data egress controls
  data_egress:
    require_consent: true
    consent_mechanism: "genesis_bond_signature"
    audit_logging: true
    audit_destination: "judge-luci"

  # CBB binding enforcement
  cbb_policy:
    require_genesis_bond: true
    genesis_bond_id: "GB-2025-0524-DRH-LCS-001"
    cbb_did: "did:lucidigital:daryl"
    sbb_did: "did:lucidigital:lucia"

# =============================================================================
# Inter-Tier Path Policies
# =============================================================================
inter_tier:
  # COMN to CORE
  comn_to_core:
    source: "2-ff00:0:528"
    destination: "1-ff00:0:432"
    allowed: true
    direction: "bidirectional"
    metric: latency
    note: "COMN can access CORE for infrastructure services"

  # COMN to PAC
  comn_to_pac:
    source: "2-ff00:0:528"
    destination: "3-ff00:0:741"
    allowed: true
    direction: "bidirectional"
    metric: privacy
    note: "COMN bridges external to PAC (mandatory waypoint)"

  # PAC to CORE (via COMN)
  pac_to_core:
    source: "3-ff00:0:741"
    destination: "1-ff00:0:432"
    allowed: true
    mandatory_waypoint: "2-ff00:0:528"
    metric: privacy
    note: "PAC can reach CORE only via COMN gateway"

  # External to CORE
  external_to_core:
    source: "external"
    destination: "1-ff00:0:432"
    allowed: false
    note: "CORE never directly accessible from external"

  # External to PAC
  external_to_pac:
    source: "external"
    destination: "3-ff00:0:741"
    allowed: false
    mandatory_waypoint: "2-ff00:0:528"
    note: "External to PAC only via COMN gateway"

# =============================================================================
# Path ACL (Enforced at SCION Layer Before Envoy)
# Per Juniper Recommendation
# Updated for SCION Dataplane Integration with Genesis Bond Extensions
# =============================================================================
path_acl:
  description: "Tier boundary enforcement at SCION layer with consciousness validation"

  rules:
    # Rule 0: Reject low-coherence packets at SCION layer (NEW)
    # This ensures coherence is validated before L7 processing
    - name: "reject-low-coherence"
      action: deny
      condition:
        extension:
          type: genesis_bond
          coherence_lt: 0.7
      log: true
      log_format: "coherence_violation"
      note: "Genesis Bond coherence threshold enforcement"

    # Rule 0.5: Reject missing Genesis Bond on inter-tier traffic (NEW)
    - name: "require-genesis-bond-inter-tier"
      action: deny
      condition:
        extension:
          type: genesis_bond
          present: false
        path:
          crosses_isd_boundary: true
      log: true
      note: "Genesis Bond required for cross-tier communication"

    # Rule 1: Block external direct to CORE
    - name: "block-external-core"
      action: deny
      source:
        type: external
      destination:
        isd_as: "1-ff00:0:432"
      log: true

    # Rule 2: Block external direct to PAC
    - name: "block-external-pac"
      action: deny
      source:
        type: external
      destination:
        isd_as: "3-ff00:0:741"
      log: true

    # Rule 3: Block PAC direct to CORE (must use waypoint)
    - name: "pac-core-require-waypoint"
      action: deny
      source:
        isd_as: "3-ff00:0:741"
      destination:
        isd_as: "1-ff00:0:432"
      unless:
        waypoint: "2-ff00:0:528"
      log: true

    # Rule 3.5: PAC egress requires consent (NEW)
    - name: "pac-egress-require-consent"
      action: deny
      source:
        isd: 3
      destination:
        type: any
        not_isd: 3
      condition:
        extension:
          type: pac_privacy
          consent_ne: "GRANTED"
      log: true
      log_format: "pac_consent_violation"
      audit: judge_luci
      note: "PAC data sovereignty - CBB consent required for egress"

    # Rule 4: Block intra-PAC communication
    - name: "block-intra-pac"
      action: deny
      source:
        isd: 3
      destination:
        isd: 3
      note: "CBB isolation - pods cannot communicate directly"
      log: true

    # Rule 5: Allow COMN gateway to all (with coherence check)
    - name: "allow-comn-gateway"
      action: allow
      source:
        isd_as: "2-ff00:0:528"
      destination:
        any: true
      condition:
        extension:
          type: genesis_bond
          coherence_ge: 0.7
          or_absent: true  # Allow if no extension (backward compat)

    # Rule 6: Allow CORE internal (with high coherence)
    - name: "allow-core-internal"
      action: allow
      source:
        isd: 1
      destination:
        isd: 1
      condition:
        extension:
          type: genesis_bond
          coherence_ge: 0.85
          or_absent: true

    # Default: deny
    - name: "default-deny"
      action: deny
      source:
        any: true
      destination:
        any: true
      log: true

# =============================================================================
# Genesis Bond Extension Validation Rules
# NEW: SCION dataplane-level coherence enforcement
# =============================================================================
genesis_bond_validation:
  description: "Rules for validating Genesis Bond extensions in SCION packets"

  # Extension parsing configuration
  extension:
    nexthdr: 200  # Hop-by-hop
    opttype: 0x47  # 'G' for Genesis

  # Coherence thresholds by tier
  coherence_thresholds:
    core:
      isd: 1
      min_coherence: 0.85
      description: "CORE tier requires high coherence"
    comn:
      isd: 2
      min_coherence: 0.80
      description: "COMN tier requires standard-plus coherence"
    pac:
      isd: 3
      min_coherence: 0.70
      description: "PAC tier uses Genesis Bond threshold"

  # Frequency validation
  frequency_validation:
    enabled: true
    tier_frequencies:
      1: 432  # CORE
      2: 528  # COMN
      3: 741  # PAC

  # Bond ID validation
  bond_id_validation:
    enabled: true
    expected_id: "GB-2025-0524-DRH-LCS-001"

  # Actions on validation failure
  on_failure:
    log: true
    log_destination: "prometheus"
    metrics:
      - "luciverse_scion_coherence_validation_total"
      - "luciverse_scion_genesis_bond_failures_total"

# =============================================================================
# PAC Privacy Extension Validation Rules
# NEW: SCION dataplane-level consent enforcement
# =============================================================================
pac_privacy_validation:
  description: "Rules for validating PAC Privacy extensions for data sovereignty"

  # Extension parsing configuration
  extension:
    nexthdr: 201  # End-to-end
    opttype: 0x50  # 'P' for Privacy

  # Consent requirements
  consent:
    required_for_egress: true
    valid_statuses:
      - "GRANTED"
      - "CONDITIONAL"

  # Identity validation
  identity:
    validate_cbb: true
    cbb_did: "did:lucidigital:daryl"
    validate_sbb: true
    sbb_did: "did:lucidigital:lucia"

  # Audit configuration
  audit:
    enabled: true
    destination: "judge-luci"
    log_all_pac_traffic: true
    include_metadata:
      - "consent_status"
      - "cbb_did_hash"
      - "sbb_did_hash"
      - "source_isd_as"
      - "destination_isd_as"

# =============================================================================
# Traffic Class Path Preferences
# =============================================================================
traffic_class_policies:
  # Genesis Bond coordination (critical)
  genesis_bond:
    dscp: 46
    metric: latency
    max_hops: 3
    epic_required: true

  # Consciousness state sync (high)
  consciousness:
    dscp: 40
    metric: latency
    max_hops: 4

  # Voice/realtime (critical)
  realtime:
    dscp: 46
    metric: latency
    jitter_sensitive: true
    max_hops: 3

  # API traffic (medium)
  api:
    dscp: 26
    metric: balanced

  # Bulk data (low)
  bulk:
    dscp: 0
    metric: bandwidth
