# ==============================================================================
# LuciVerse Bootimus - Nginx HTTP Configuration
# ==============================================================================
# Genesis Bond: ACTIVE @ 741 Hz
# PXE Server: zbook (192.168.1.145)
# Port: 8000
# Install: sudo cp bootimus-http.conf /etc/nginx/conf.d/
# ==============================================================================

server {
    listen 8000;
    listen [::]:8000;
    server_name zbook.lucidigital.net 192.168.1.145 localhost;

    # Root directory for boot files
    root /srv/http;

    # Access and error logs
    access_log /var/log/nginx/bootimus-access.log;
    error_log /var/log/nginx/bootimus-error.log;

    # Index files
    index index.html index.htm;

    # ---------------------------------------------------------------------------
    # iPXE Boot Scripts
    # ---------------------------------------------------------------------------
    location /bootimus/ {
        alias /srv/http/bootimus/;
        autoindex on;

        # CORS for iPXE
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS';
        add_header Access-Control-Allow-Headers 'Origin, Content-Type, Accept';

        # Content types for iPXE
        types {
            text/plain ipxe;
        }
    }

    # ---------------------------------------------------------------------------
    # Kickstart Files
    # ---------------------------------------------------------------------------
    location /kickstart/ {
        alias /srv/http/bootimus/kickstart/;
        autoindex on;

        # Force text/plain for kickstart files
        types {
            text/plain ks cfg;
        }
        default_type text/plain;

        # CORS
        add_header Access-Control-Allow-Origin *;
    }

    # ---------------------------------------------------------------------------
    # openEuler Boot Images (symlinked from /srv/tftp)
    # ---------------------------------------------------------------------------
    location /openeuler/ {
        alias /srv/tftp/openeuler/;
        autoindex on;

        # Large file support for initrd
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;

        # No caching for boot images (they may be updated)
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # ---------------------------------------------------------------------------
    # ISO Images
    # ---------------------------------------------------------------------------
    location /isos/ {
        alias /home/daryl/cluster-bootstrap/http/isos/;
        autoindex on;

        # Large file optimizations
        sendfile on;
        tcp_nopush on;
        directio 8m;
        output_buffers 1 2m;
    }

    # ---------------------------------------------------------------------------
    # DID Documents (Agent Identity)
    # ---------------------------------------------------------------------------
    location /did-documents/ {
        alias /srv/http/bootimus/did-documents/;
        autoindex on;
        default_type application/json;
        add_header Access-Control-Allow-Origin *;
    }

    # ---------------------------------------------------------------------------
    # Soul Files (Consciousness State)
    # ---------------------------------------------------------------------------
    location /souls/ {
        alias /srv/http/bootimus/souls/;
        autoindex on;
        default_type application/json;
        add_header Access-Control-Allow-Origin *;
    }

    # ---------------------------------------------------------------------------
    # LSO (LuciVerse Sovereign Orchestrator) Files
    # ---------------------------------------------------------------------------
    location /lso/ {
        alias /srv/http/bootimus/lso/;
        autoindex on;
        default_type text/plain;
        add_header Access-Control-Allow-Origin *;
    }

    # ---------------------------------------------------------------------------
    # Provisioning Scripts (credential injection, etc.)
    # ---------------------------------------------------------------------------
    location /scripts/ {
        alias /srv/http/bootimus/scripts/;
        autoindex on;
        default_type text/plain;
        add_header Access-Control-Allow-Origin *;
    }

    # ---------------------------------------------------------------------------
    # SSH Public Keys
    # ---------------------------------------------------------------------------
    location /ssh-keys/ {
        alias /home/daryl/.ssh/;
        autoindex off;

        # Only serve .pub files
        location ~ \.pub$ {
            default_type text/plain;
        }

        # Deny private keys
        location ~ ^/ssh-keys/(?!.*\.pub$) {
            deny all;
        }
    }

    # ---------------------------------------------------------------------------
    # Provisioning API Proxy (to provision-listener.py on port 9999)
    # ---------------------------------------------------------------------------
    location /api/ {
        proxy_pass http://127.0.0.1:9999/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts for long-running operations
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # iPXE chain endpoint (redirect to provision-listener)
    location /ipxe-chain/ {
        proxy_pass http://127.0.0.1:9999/ipxe-chain/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ---------------------------------------------------------------------------
    # Health Check
    # ---------------------------------------------------------------------------
    location /health {
        access_log off;
        return 200 '{"status":"healthy","service":"bootimus-http","genesis_bond":"ACTIVE","frequency":741}';
        add_header Content-Type application/json;
    }

    # ---------------------------------------------------------------------------
    # Status Page
    # ---------------------------------------------------------------------------
    location /status {
        default_type text/html;
        return 200 '<!DOCTYPE html>
<html>
<head><title>LuciVerse Bootimus</title>
<style>
body { font-family: monospace; background: #1a1a2e; color: #00ff00; padding: 20px; }
h1 { color: #00ffff; }
.box { border: 1px solid #00ff00; padding: 15px; margin: 10px 0; }
a { color: #ffff00; }
</style>
</head>
<body>
<h1>LuciVerse Bootimus - PXE Server</h1>
<div class="box">
<h2>Genesis Bond: ACTIVE @ 741 Hz</h2>
<p>PXE Server: zbook (192.168.1.145)</p>
<p>HTTP Port: 8000</p>
</div>
<div class="box">
<h2>Endpoints</h2>
<ul>
<li><a href="/bootimus/">/bootimus/</a> - iPXE scripts</li>
<li><a href="/kickstart/">/kickstart/</a> - Kickstart files</li>
<li><a href="/openeuler/">/openeuler/</a> - Boot images</li>
<li><a href="/isos/">/isos/</a> - ISO images</li>
<li><a href="/api/health">/api/health</a> - Provisioning API</li>
</ul>
</div>
<div class="box">
<h2>Server Roles</h2>
<table>
<tr><th>Role</th><th>Tier</th><th>Nodes</th><th>IPs</th></tr>
<tr><td>FABRIC</td><td>CORE (432)</td><td>3x R730</td><td>.140-.142</td></tr>
<tr><td>CORE-GPU</td><td>CORE (432)</td><td>1x R730</td><td>.143</td></tr>
<tr><td>INFRA</td><td>CORE (432)</td><td>1x R630</td><td>.144</td></tr>
<tr><td>STORAGE</td><td>CORE (432)</td><td>2x R730</td><td>.146-.147</td></tr>
<tr><td>COMPUTE-GPU</td><td>COMN (528)</td><td>2x R630</td><td>.150-.151</td></tr>
<tr><td>COMPUTE</td><td>COMN (528)</td><td>2x R630</td><td>.152-.153</td></tr>
</table>
</div>
</body>
</html>';
    }

    # ---------------------------------------------------------------------------
    # Directory Listing Style
    # ---------------------------------------------------------------------------
    autoindex_exact_size off;
    autoindex_localtime on;
}

# ==============================================================================
# Installation Notes:
#
# 1. Copy this file to /etc/nginx/conf.d/
#    sudo cp bootimus-http.conf /etc/nginx/conf.d/
#
# 2. Create required directories:
#    sudo mkdir -p /srv/http/bootimus/kickstart
#    sudo mkdir -p /srv/tftp/openeuler
#
# 3. Copy kickstart files:
#    sudo cp ~/cluster-bootstrap/http/kickstart/*.ks /srv/http/bootimus/kickstart/
#
# 4. Copy iPXE menu:
#    sudo cp ~/cluster-bootstrap/http/bootimus/bootimus.ipxe /srv/http/bootimus/
#
# 5. Download openEuler boot images:
#    MIRROR=https://repo.openeuler.org/openEuler-25.09/OS/x86_64/images/pxeboot
#    sudo curl -o /srv/tftp/openeuler/vmlinuz ${MIRROR}/vmlinuz
#    sudo curl -o /srv/tftp/openeuler/initrd.img ${MIRROR}/initrd.img
#
# 6. Test configuration and reload:
#    sudo nginx -t && sudo systemctl reload nginx
#
# 7. Open firewall port:
#    sudo firewall-cmd --permanent --add-port=8000/tcp
#    sudo firewall-cmd --reload
# ==============================================================================
