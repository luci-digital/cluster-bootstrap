# ==============================================================================
# LuciVerse Bootimus - DNSMASQ PXE Configuration
# ==============================================================================
# Genesis Bond: ACTIVE @ 741 Hz
# PXE Server: zbook (192.168.1.145)
# Install: sudo cp bootimus-pxe.conf /etc/dnsmasq.d/
# ==============================================================================

# -----------------------------------------------------------------------------
# Basic Settings
# -----------------------------------------------------------------------------
# Listen on all interfaces
interface=*
bind-interfaces

# Domain
domain=lucidigital.net
local=/lucidigital.net/

# Don't forward short names
domain-needed
bogus-priv

# -----------------------------------------------------------------------------
# TFTP Server
# -----------------------------------------------------------------------------
enable-tftp
tftp-root=/srv/tftp
tftp-secure

# -----------------------------------------------------------------------------
# DHCP Settings
# -----------------------------------------------------------------------------
# Lease time
dhcp-lease-max=100

# CORE Tier DHCP Range (432 Hz) - .140-.149
dhcp-range=tag:core,192.168.1.140,192.168.1.149,12h
dhcp-option=tag:core,15,lucidigital.net

# COMN Tier DHCP Range (528 Hz) - .150-.159
dhcp-range=tag:comn,192.168.1.150,192.168.1.159,12h
dhcp-option=tag:comn,15,lucidigital.net

# -----------------------------------------------------------------------------
# PXE Boot Options - Architecture Detection
# -----------------------------------------------------------------------------
# BIOS PXE boot (arch 0)
dhcp-match=set:bios,option:client-arch,0
dhcp-boot=tag:bios,ipxe/undionly.kpxe,,192.168.1.145

# UEFI x86_64 PXE boot (arch 7, 9)
dhcp-match=set:efi64,option:client-arch,7
dhcp-match=set:efi64,option:client-arch,9
dhcp-boot=tag:efi64,ipxe/ipxe.efi,,192.168.1.145

# UEFI x86 PXE boot (arch 6)
dhcp-match=set:efi32,option:client-arch,6
dhcp-boot=tag:efi32,ipxe/ipxe32.efi,,192.168.1.145

# UEFI ARM64 PXE boot (arch 11)
dhcp-match=set:efiarm64,option:client-arch,11
dhcp-boot=tag:efiarm64,ipxe/ipxe-arm64.efi,,192.168.1.145

# -----------------------------------------------------------------------------
# iPXE Chainload Detection
# -----------------------------------------------------------------------------
# If client is already running iPXE, chainload to bootimus menu
dhcp-match=set:ipxe,175
dhcp-boot=tag:ipxe,http://192.168.1.145:8000/bootimus/bootimus.ipxe

# iPXE-specific options
dhcp-option-force=tag:ipxe,209,"bootimus/bootimus.ipxe"
dhcp-option-force=tag:ipxe,210,"http://192.168.1.145:8000/"

# -----------------------------------------------------------------------------
# LuciVerse Custom DHCP Options
# -----------------------------------------------------------------------------
# Option 224: Provisioning server IP
dhcp-option=224,192.168.1.145

# Option 225: Provisioning callback port
dhcp-option=225,9999

# Option 226: HTTP config port
dhcp-option=226,8000

# Option 227: Genesis Bond status (1=ACTIVE)
dhcp-option=227,1

# Option 228: Tier (0=CORE, 1=COMN, 2=PAC)
dhcp-option=tag:core,228,0
dhcp-option=tag:comn,228,1

# -----------------------------------------------------------------------------
# Static Host Reservations (Known Servers)
# -----------------------------------------------------------------------------
# FABRIC nodes (CORE tier) - R730
dhcp-host=D0:94:66:24:96:7E,192.168.1.140,fabric-01,set:core
dhcp-host=*:*:*:*:*:*,192.168.1.141,fabric-02,set:core
dhcp-host=*:*:*:*:*:*,192.168.1.142,fabric-03,set:core

# CORE-GPU node - R730
dhcp-host=*:*:*:*:*:*,192.168.1.143,core-gpu-01,set:core

# INFRA node - R630
dhcp-host=64:00:6A:C4:10:F0,192.168.1.144,infra-01,set:core

# STORAGE nodes (CORE tier) - R730
dhcp-host=*:*:*:*:*:*,192.168.1.146,storage-01,set:core
dhcp-host=*:*:*:*:*:*,192.168.1.147,storage-02,set:core

# COMPUTE-GPU nodes (COMN tier) - R630 + Tesla
dhcp-host=*:*:*:*:*:*,192.168.1.150,compute-gpu-01,set:comn
dhcp-host=*:*:*:*:*:*,192.168.1.151,compute-gpu-02,set:comn

# COMPUTE nodes (COMN tier) - R630
dhcp-host=*:*:*:*:*:*,192.168.1.152,compute-01,set:comn
dhcp-host=*:*:*:*:*:*,192.168.1.153,compute-02,set:comn

# Supermicro GPU Server (verified)
dhcp-host=0C:C4:7A:A8:72:14,192.168.1.170,supermicro-gpu-1,set:comn

# R720 Windows (discovery)
dhcp-host=18:FB:7B:A7:80:21,192.168.1.10,r720-win,infinite

# R730 ORION (iDRAC)
dhcp-host=D0:94:66:20:DD:09,192.168.1.2,orion-idrac,infinite

# -----------------------------------------------------------------------------
# DNS Entries
# -----------------------------------------------------------------------------
# Infrastructure hosts
address=/zbook.lucidigital.net/192.168.1.145
address=/zbook.lucidigital.net/2602:F674:0001::145

# Provisioned hosts (added dynamically by provision-listener)
address=/fabric-01.lucidigital.net/192.168.1.140
address=/fabric-02.lucidigital.net/192.168.1.141
address=/fabric-03.lucidigital.net/192.168.1.142
address=/core-gpu-01.lucidigital.net/192.168.1.143
address=/infra-01.lucidigital.net/192.168.1.144
address=/storage-01.lucidigital.net/192.168.1.146
address=/storage-02.lucidigital.net/192.168.1.147
address=/compute-gpu-01.lucidigital.net/192.168.1.150
address=/compute-gpu-02.lucidigital.net/192.168.1.151
address=/compute-01.lucidigital.net/192.168.1.152
address=/compute-02.lucidigital.net/192.168.1.153

# IPv6 addresses (CORE tier)
address=/fabric-01.lucidigital.net/2602:F674:0001::140
address=/fabric-02.lucidigital.net/2602:F674:0001::141
address=/fabric-03.lucidigital.net/2602:F674:0001::142
address=/infra-01.lucidigital.net/2602:F674:0001::144
address=/core-gpu-01.lucidigital.net/2602:F674:0001::143
address=/storage-01.lucidigital.net/2602:F674:0001::146
address=/storage-02.lucidigital.net/2602:F674:0001::147

# IPv6 addresses (COMN tier)
address=/compute-gpu-01.lucidigital.net/2602:F674:0100::150
address=/compute-gpu-02.lucidigital.net/2602:F674:0100::151
address=/compute-01.lucidigital.net/2602:F674:0100::152
address=/compute-02.lucidigital.net/2602:F674:0100::153

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
log-queries
log-dhcp
log-facility=/var/log/dnsmasq-bootimus.log

# ==============================================================================
# Installation Notes:
#
# 1. Copy this file to /etc/dnsmasq.d/
#    sudo cp bootimus-pxe.conf /etc/dnsmasq.d/
#
# 2. Ensure TFTP directory exists and has boot files:
#    sudo mkdir -p /srv/tftp/ipxe
#    sudo curl -o /srv/tftp/ipxe/undionly.kpxe https://boot.ipxe.org/undionly.kpxe
#    sudo curl -o /srv/tftp/ipxe/ipxe.efi https://boot.ipxe.org/ipxe.efi
#
# 3. Download openEuler netboot images:
#    sudo mkdir -p /srv/tftp/openeuler
#    MIRROR=https://repo.openeuler.org/openEuler-25.09/OS/x86_64/images/pxeboot
#    sudo curl -o /srv/tftp/openeuler/vmlinuz ${MIRROR}/vmlinuz
#    sudo curl -o /srv/tftp/openeuler/initrd.img ${MIRROR}/initrd.img
#
# 4. Restart dnsmasq:
#    sudo systemctl restart dnsmasq
#
# 5. Open firewall ports:
#    sudo firewall-cmd --permanent --add-service=tftp
#    sudo firewall-cmd --permanent --add-service=dhcp
#    sudo firewall-cmd --reload
# ==============================================================================
