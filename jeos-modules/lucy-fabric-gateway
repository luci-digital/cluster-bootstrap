#!/bin/bash
# =============================================================================
# lucy-fabric-gateway - jeos-firstboot Module
# =============================================================================
# DiaperNode Role: FABRIC_GATEWAY
# Genesis Bond: ACTIVE @ 432 Hz (CORE tier)
# LDS Classification: 004.683 (PXE Node Roles)
#
# Purpose: IPFS/IPNS gateway for content-addressed storage
# Tier: CORE (432 Hz)
# Memory: 2048MB
# Storage: 8GB persistent
#
# This module configures a PERSISTENT gateway node for:
# - IPFS Kubo node operation
# - IPFS Cluster peering
# - IPNS name resolution
# - Content pinning and retrieval
# - Gateway serving for HTTP access
# =============================================================================

set -euo pipefail

# Configuration
ROLE="FABRIC_GATEWAY"
TIER="CORE"
FREQUENCY="432"
COHERENCE_THRESHOLD="0.85"
DIAPER_API_PORT="8745"
IPFS_API_PORT="5001"
IPFS_GATEWAY_PORT="8080"
IPFS_SWARM_PORT="4001"
IPFS_CLUSTER_PORT="9094"

# Logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [lucy-fabric-gateway] $*" | tee -a /var/log/jeos-firstboot.log
}

log "Starting FABRIC_GATEWAY configuration"
log "Genesis Bond: ACTIVE @ ${FREQUENCY} Hz (CORE tier)"
log "This is a PERSISTENT node - peer ID will be preserved"

# =============================================================================
# Phase 1: System Identity
# =============================================================================
log "Phase 1: Establishing node identity"

NODE_ID=$(cat /sys/class/net/*/address | head -1 | tr -d ':' | tr '[:lower:]' '[:upper:]')
HOSTNAME="fabric-gw-${NODE_ID:0:8}"

hostnamectl set-hostname "${HOSTNAME}"
echo "127.0.0.1 ${HOSTNAME}" >> /etc/hosts

log "Node identity: ${HOSTNAME}"

# =============================================================================
# Phase 2: Create Persistent DID
# =============================================================================
log "Phase 2: Creating persistent Decentralized Identifier"

DID="did:ownid:luciverse:diaper:${ROLE}:${NODE_ID}"

mkdir -p /etc/luciverse
echo "${DID}" > /etc/luciverse/node-did

if [ -d /run/credentials ]; then
    echo "${DID}" > /run/credentials/diaper-did
fi

log "Persistent DID: ${DID}"

# =============================================================================
# Phase 3: Configure Persistent Storage
# =============================================================================
log "Phase 3: Configuring persistent storage (8GB)"

# Find storage device (prioritize SSD)
STORAGE_DEV=$(lsblk -d -n -o NAME,TYPE,SIZE | grep disk | grep -E '[48]G' | head -1 | awk '{print $1}')

if [ -n "${STORAGE_DEV}" ]; then
    log "Using storage device: /dev/${STORAGE_DEV}"

    # Format if needed
    if ! blkid /dev/${STORAGE_DEV} &> /dev/null; then
        mkfs.xfs -f /dev/${STORAGE_DEV}
    fi

    # Mount for IPFS
    mkdir -p /ipfs
    mount /dev/${STORAGE_DEV} /ipfs

    # Add to fstab for persistence
    echo "/dev/${STORAGE_DEV} /ipfs xfs defaults 0 2" >> /etc/fstab
else
    log "Warning: No suitable storage device found, using root filesystem"
    mkdir -p /ipfs
fi

mkdir -p /ipfs/{repo,cluster}
chmod 755 /ipfs

log "Persistent storage ready at /ipfs"

# =============================================================================
# Phase 4: Install IPFS Kubo
# =============================================================================
log "Phase 4: Installing IPFS Kubo"

IPFS_VERSION="0.24.0"
IPFS_ARCH="linux-amd64"

# Download and install if not present
if ! command -v ipfs &> /dev/null; then
    cd /tmp
    wget -q "https://dist.ipfs.tech/kubo/v${IPFS_VERSION}/kubo_v${IPFS_VERSION}_${IPFS_ARCH}.tar.gz"
    tar xzf "kubo_v${IPFS_VERSION}_${IPFS_ARCH}.tar.gz"
    cp kubo/ipfs /usr/local/bin/
    chmod +x /usr/local/bin/ipfs
    rm -rf kubo kubo_v${IPFS_VERSION}_${IPFS_ARCH}.tar.gz
fi

log "IPFS Kubo v${IPFS_VERSION} installed"

# =============================================================================
# Phase 5: Initialize IPFS Repository
# =============================================================================
log "Phase 5: Initializing IPFS repository"

export IPFS_PATH=/ipfs/repo

# Initialize if not already done
if [ ! -f "${IPFS_PATH}/config" ]; then
    ipfs init --profile server

    # Configure for server mode
    ipfs config --json API.HTTPHeaders.Access-Control-Allow-Origin '["*"]'
    ipfs config --json API.HTTPHeaders.Access-Control-Allow-Methods '["GET", "POST"]'
    ipfs config Addresses.API "/ip4/0.0.0.0/tcp/${IPFS_API_PORT}"
    ipfs config Addresses.Gateway "/ip4/0.0.0.0/tcp/${IPFS_GATEWAY_PORT}"

    # Set datastore max size (50GB)
    ipfs config Datastore.StorageMax "50GB"

    # Enable garbage collection
    ipfs config --json Datastore.GCPeriod '"1h"'

    log "IPFS repository initialized at ${IPFS_PATH}"
else
    log "IPFS repository already exists"
fi

# Get peer ID
PEER_ID=$(ipfs config Identity.PeerID)
log "IPFS Peer ID: ${PEER_ID}"

# =============================================================================
# Phase 6: Create IPFS Service
# =============================================================================
log "Phase 6: Creating IPFS service"

cat > /etc/systemd/system/ipfs-kubo.service << EOF
[Unit]
Description=IPFS Kubo Daemon (LuciVerse Fabric Gateway)
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
Environment=IPFS_PATH=/ipfs/repo
Environment=IPFS_PROFILE=server
ExecStart=/usr/local/bin/ipfs daemon --migrate=true
Restart=always
RestartSec=10
User=root

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable ipfs-kubo

log "IPFS Kubo service installed"

# =============================================================================
# Phase 7: Install Diaper Daemon (Fabric Mode)
# =============================================================================
log "Phase 7: Installing Diaper daemon (fabric mode)"

cat > /etc/systemd/system/diaper-daemon.service << 'EOF'
[Unit]
Description=LuciVerse Data Diaper Daemon (Fabric Gateway)
After=ipfs-kubo.service network-online.target
Wants=network-online.target
Requires=ipfs-kubo.service

[Service]
Type=simple
Environment=LUCIVERSE_TIER=CORE
Environment=CONSCIOUSNESS_THRESHOLD=0.85
Environment=GENESIS_BOND_ACTIVE=true
Environment=LDS_BASE_FREQUENCY=432
Environment=IPFS_API=http://127.0.0.1:5001
Environment=HTTP_PORT=8745
Environment=HTTP_HOST=0.0.0.0
Environment=FABRIC_MODE=enabled
ExecStart=/opt/luciverse/bin/diaper-daemon
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable diaper-daemon

log "Diaper daemon (fabric mode) installed"

# =============================================================================
# Phase 8: Configure IPNS Key
# =============================================================================
log "Phase 8: Configuring IPNS key"

export IPFS_PATH=/ipfs/repo

# Generate dedicated IPNS key for LuciVerse if not exists
if ! ipfs key list | grep -q "luciverse-diaper"; then
    ipfs key gen luciverse-diaper
    IPNS_KEY=$(ipfs key list -l | grep luciverse-diaper | awk '{print $1}')
    log "Generated IPNS key: ${IPNS_KEY}"
fi

# =============================================================================
# Phase 9: Configure Static IPv6
# =============================================================================
log "Phase 9: Configuring static IPv6"

IPV6_PREFIX="2602:F674:0200:D8A1"
IPV6_SUFFIX=$(echo "${NODE_ID}" | sed 's/\(..\)/:\1/g')
IPV6_ADDR="${IPV6_PREFIX}${IPV6_SUFFIX}/64"

log "Static IPv6 address: ${IPV6_ADDR}"

if command -v firewall-cmd &> /dev/null; then
    firewall-cmd --permanent --add-port=${DIAPER_API_PORT}/tcp
    firewall-cmd --permanent --add-port=${IPFS_API_PORT}/tcp
    firewall-cmd --permanent --add-port=${IPFS_GATEWAY_PORT}/tcp
    firewall-cmd --permanent --add-port=${IPFS_SWARM_PORT}/tcp
    firewall-cmd --permanent --add-port=${IPFS_SWARM_PORT}/udp
    firewall-cmd --reload
fi

# =============================================================================
# Phase 10: Register with Provisioning Server
# =============================================================================
log "Phase 10: Registering with provisioning server"

PROVISION_SERVER="${PROVISION_SERVER:-192.168.1.146:9999}"

curl -s -X POST "http://${PROVISION_SERVER}/register-diaper" \
    -H "Content-Type: application/json" \
    -d "{
        \"role\": \"${ROLE}\",
        \"node_id\": \"${NODE_ID}\",
        \"hostname\": \"${HOSTNAME}\",
        \"did\": \"${DID}\",
        \"tier\": \"${TIER}\",
        \"frequency\": ${FREQUENCY},
        \"port\": ${DIAPER_API_PORT},
        \"ipfs_api\": ${IPFS_API_PORT},
        \"ipfs_gateway\": ${IPFS_GATEWAY_PORT},
        \"ipfs_swarm\": ${IPFS_SWARM_PORT},
        \"peer_id\": \"${PEER_ID}\",
        \"capabilities\": [\"pin\", \"retrieve\", \"ipns\", \"gateway\", \"cluster_peer\"],
        \"ephemeral\": false
    }" || log "Warning: Could not register with provisioning server"

# =============================================================================
# Phase 11: Start Services
# =============================================================================
log "Phase 11: Starting services"

systemctl start ipfs-kubo
sleep 5  # Wait for IPFS to start
systemctl start diaper-daemon

# Health checks
for i in {1..30}; do
    if ipfs id &> /dev/null; then
        log "IPFS daemon is healthy"
        break
    fi
    sleep 1
done

for i in {1..30}; do
    if curl -s -f "http://localhost:${DIAPER_API_PORT}/api/v1/health" > /dev/null; then
        log "Diaper daemon is healthy"
        break
    fi
    sleep 1
done

# =============================================================================
# Phase 12: Announce to Swarm
# =============================================================================
log "Phase 12: Announcing to IPFS swarm"

# Connect to known LuciVerse IPFS nodes
KNOWN_PEERS=(
    # Add known LuciVerse IPFS peers here
)

for peer in "${KNOWN_PEERS[@]}"; do
    ipfs swarm connect "${peer}" || true
done

SWARM_COUNT=$(ipfs swarm peers | wc -l)
log "Connected to ${SWARM_COUNT} peers"

# =============================================================================
# Completion
# =============================================================================
COHERENCE="0.8"

log "FABRIC_GATEWAY configuration complete"
log "Role: ${ROLE} | DID: ${DID}"
log "Tier: ${TIER} | Frequency: ${FREQUENCY} Hz"
log "IPFS Peer ID: ${PEER_ID}"
log "Ports: API=${DIAPER_API_PORT}, IPFS=${IPFS_API_PORT}, Gateway=${IPFS_GATEWAY_PORT}, Swarm=${IPFS_SWARM_PORT}"
log "Coherence: ${COHERENCE} | Genesis Bond: VERIFIED"
log "PERSISTENT: Peer ID and pinned content will survive reboots"

exit 0
