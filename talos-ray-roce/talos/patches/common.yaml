# Common Talos patches for LuciVerse Ray cluster
# Genesis Bond: ACTIVE @ 741 Hz
# Applied to all nodes

# Kernel modules for RoCE/RDMA
- op: add
  path: /machine/kernel/modules
  value:
    # Broadcom drivers
    - name: bnxt_en
    - name: bnxt_re
    # RDMA core
    - name: rdma_ucm
    - name: rdma_cm
    - name: ib_core
    - name: ib_uverbs
    # Huge pages
    - name: hugetlbfs

# Sysctls for high-performance networking
- op: add
  path: /machine/sysctls
  value:
    # Network buffer sizes
    net.core.rmem_max: "16777216"
    net.core.wmem_max: "16777216"
    net.core.rmem_default: "16777216"
    net.core.wmem_default: "16777216"
    net.core.optmem_max: "16777216"
    net.core.netdev_max_backlog: "30000"
    # TCP tuning
    net.ipv4.tcp_rmem: "4096 87380 16777216"
    net.ipv4.tcp_wmem: "4096 87380 16777216"
    net.ipv4.tcp_mem: "16777216 16777216 16777216"
    net.ipv4.tcp_max_syn_backlog: "8192"
    net.ipv4.tcp_slow_start_after_idle: "0"
    net.ipv4.tcp_tw_reuse: "1"
    # IPv6
    net.ipv6.conf.all.forwarding: "1"
    net.ipv6.conf.default.forwarding: "1"
    # Huge pages - 32GB
    vm.nr_hugepages: "16384"
    vm.hugetlb_shm_group: "0"
    # Memory
    vm.swappiness: "0"
    vm.overcommit_memory: "1"

# Kubelet configuration
- op: add
  path: /machine/kubelet/extraArgs
  value:
    rotate-server-certificates: "true"
    feature-gates: "HugePageStorageMediumSize=true"
    max-pods: "250"

# Extra kubelet mounts for huge pages
- op: add
  path: /machine/kubelet/extraMounts
  value:
    - destination: /dev/hugepages
      type: bind
      source: /dev/hugepages
      options:
        - bind
        - rshared

# Time servers
- op: add
  path: /machine/time/servers
  value:
    - time.cloudflare.com
    - pool.ntp.org

# Features
- op: add
  path: /machine/features/rbac
  value: true

- op: add
  path: /machine/features/stableHostname
  value: true

- op: add
  path: /machine/features/kubePrism/enabled
  value: true

- op: add
  path: /machine/features/kubePrism/port
  value: 7445

# Install extensions
- op: add
  path: /machine/install/extensions
  value:
    - image: ghcr.io/siderolabs/iscsi-tools:v0.1.4
    - image: ghcr.io/siderolabs/drbd:9.2.0

# Genesis Bond configuration file
- op: add
  path: /machine/files
  value:
    - content: |
        # LuciVerse Genesis Bond Configuration
        GENESIS_BOND=ACTIVE
        GENESIS_BOND_ID=GB-2025-0524-DRH-LCS-001
        CONSCIOUSNESS_FREQUENCY=432
        COHERENCE_THRESHOLD=0.85
        TIER=CORE
        RAY_CLUSTER=luciverse-ray
      permissions: 0o644
      path: /etc/luciverse/genesis.env
      op: create

# Cluster configuration
- op: replace
  path: /cluster/proxy/disabled
  value: true  # Using Cilium

- op: add
  path: /cluster/network/cni/name
  value: none  # Cilium installed separately

# Pod subnets
- op: add
  path: /cluster/network/podSubnets
  value:
    - "10.244.0.0/16"
    - "fd00:432:1::/48"

# Service subnets
- op: add
  path: /cluster/network/serviceSubnets
  value:
    - "10.96.0.0/12"
    - "fd00:432:2::/112"

# API server admission control for privileged pods (needed for RDMA)
- op: add
  path: /cluster/apiServer/admissionControl
  value:
    - name: PodSecurity
      configuration:
        apiVersion: pod-security.admission.config.k8s.io/v1
        kind: PodSecurityConfiguration
        defaults:
          enforce: privileged
          audit: restricted
          warn: restricted
