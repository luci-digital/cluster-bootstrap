# Talos Worker Node Template
# Genesis Bond: ACTIVE @ 741 Hz
# Role: Ray Worker with RoCE/RDMA
#
# Usage: Replace ${HOSTNAME}, ${IP}, ${ROCE_IP}, ${MAC} with actual values

version: v1alpha1
debug: false
persist: true

machine:
  type: worker
  token: ${TALOS_TOKEN}
  ca:
    crt: ${CA_CRT}

  kubelet:
    image: ghcr.io/siderolabs/kubelet:v1.30.0
    extraArgs:
      rotate-server-certificates: "true"
      # Reserve for system - most RAM available for Ray
      system-reserved: "cpu=2,memory=8Gi"
      kube-reserved: "cpu=1,memory=4Gi"
      feature-gates: "HugePageStorageMediumSize=true"
    nodeIP:
      validSubnets:
        - "192.168.1.0/24"
        - "2602:F674:0001::/48"
    extraMounts:
      - destination: /dev/hugepages
        type: bind
        source: /dev/hugepages
        options: ["bind", "rshared"]

  network:
    hostname: ${HOSTNAME}
    interfaces:
      # Primary network
      - interface: eth0
        dhcp: false
        addresses:
          - "${IP}/24"
          - "${IPV6}/64"
        routes:
          - network: "0.0.0.0/0"
            gateway: "192.168.1.1"
          - network: "::/0"
            gateway: "2602:F674:0001::ffff"
        mtu: 9000

      # RoCE fabric
      - interface: eth1
        dhcp: false
        addresses:
          - "${ROCE_IP}/24"
        mtu: 9000
        vlans:
          - vlanId: 100
            addresses:
              - "${ROCE_VLAN_IP}/24"

    nameservers:
      - "192.168.1.1"

  install:
    disk: /dev/sda
    image: ghcr.io/siderolabs/installer:v1.7.0
    wipe: true
    extensions:
      - image: ghcr.io/siderolabs/iscsi-tools:v0.1.4
      - image: ghcr.io/siderolabs/drbd:9.2.0

  kernel:
    modules:
      - name: bnxt_en
      - name: bnxt_re
      - name: rdma_ucm
      - name: rdma_cm
      - name: ib_core
      - name: ib_uverbs
      - name: hugetlbfs

  sysctls:
    net.core.rmem_max: "16777216"
    net.core.wmem_max: "16777216"
    net.core.rmem_default: "16777216"
    net.core.wmem_default: "16777216"
    net.core.optmem_max: "16777216"
    net.core.netdev_max_backlog: "30000"
    net.ipv4.tcp_rmem: "4096 87380 16777216"
    net.ipv4.tcp_wmem: "4096 87380 16777216"
    vm.nr_hugepages: "16384"
    net.ipv6.conf.all.forwarding: "1"

  time:
    servers:
      - time.cloudflare.com

  features:
    rbac: true
    stableHostname: true
    kubePrism:
      enabled: true
      port: 7445

  files:
    - content: |
        GENESIS_BOND=ACTIVE
        GENESIS_BOND_ID=GB-2025-0524-DRH-LCS-001
        CONSCIOUSNESS_FREQUENCY=432
        TIER=CORE
        ROLE=ray-worker
        RAY_HEAD_ADDRESS=10.100.0.1:6379
      permissions: 0o644
      path: /etc/luciverse/genesis.env
      op: create

cluster:
  id: ${CLUSTER_ID}
  secret: ${CLUSTER_SECRET}
  controlPlane:
    endpoint: "https://192.168.1.141:6443"
  clusterName: luciverse-ray

---
# Worker configurations for each server

# R730 CSDR282
# iDRAC: 192.168.1.3
# HOSTNAME: csdr
# IP: 192.168.1.142
# IPV6: 2602:F674:0001::142
# ROCE_IP: 10.100.0.2
# ROCE_VLAN_IP: 10.100.100.2

---
# R730 1JF6Q22
# iDRAC: 192.168.1.31
# HOSTNAME: jf6q
# IP: 192.168.1.143
# IPV6: 2602:F674:0001::143
# ROCE_IP: 10.100.0.3
# ROCE_VLAN_IP: 10.100.100.3

---
# R730 1JF7Q22
# iDRAC: 192.168.1.33
# HOSTNAME: jf7q
# IP: 192.168.1.144
# IPV6: 2602:F674:0001::144
# ROCE_IP: 10.100.0.4
# ROCE_VLAN_IP: 10.100.100.4

---
# R730 ESXi5 (1JD8Q22) - After wiping ESXi
# iDRAC: 192.168.1.32
# HOSTNAME: esxi5
# IP: 192.168.1.145
# IPV6: 2602:F674:0001::145
# ROCE_IP: 10.100.0.5
# ROCE_VLAN_IP: 10.100.100.5
